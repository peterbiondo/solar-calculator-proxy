<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PV Solar Hot Water Calculator - iSolar Hot Water Academy</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0F0F0F;
            height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 20px; overflow-x: hidden; position: relative;
        }
        body::before {
            content: ''; position: absolute; width: 900px; height: 900px;
            background: radial-gradient(circle at 30% 50%, rgba(0,230,118,0.12) 0%, rgba(0,217,255,0.08) 30%, rgba(118,75,162,0.06) 60%, transparent 80%);
            top: 50%; left: 50%; transform: translate(-60%, -50%);
            pointer-events: none; z-index: 1; filter: blur(60px);
        }
        body::after {
            content: ''; position: absolute; width: 600px; height: 600px;
            background: radial-gradient(circle at 70% 30%, rgba(0,230,118,0.05) 0%, rgba(0,217,255,0.03) 40%, rgba(118,75,162,0.02) 70%, transparent 85%);
            top: 20%; right: 10%; pointer-events: none; z-index: 1; filter: blur(50px);
        }
        .chat-container {
            width: 100%; max-width: 600px; height: 90vh; max-height: 700px;
            background: #1A1A1A; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid #2A2A2A; position: relative; z-index: 10;
        }
        .chat-header {
            background: #0F0F0F; color: #FFFFFF; padding: 20px; text-align: center;
            flex-shrink: 0; position: sticky; top: 0; z-index: 100;
            border-bottom: 2px solid #FFA500;
        }
        .chat-header h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; color: #FFFFFF; }
        .chat-header p { font-size: 14px; font-weight: 400; color: #E8E8E8; }
        .header-logo { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .header-logo-img { height: 34px; width: auto; max-width: 85%; display: block; }
        .chat-header p:first-child { font-size: 14px; font-weight: 500; color: #FFA500; margin-bottom: 5px; }
        .start-screen {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding: 40px 40px 20px 40px; text-align: center; overflow-y: hidden; background: #0F0F0F;
        }
        .start-screen h2 { color: #FFA500; font-size: 28px; font-weight: 700; margin-bottom: 15px; }
        .start-screen p { color: #E8E8E8; font-size: 16px; font-weight: 400; margin-bottom: 10px; line-height: 1.6; }
        .start-screen p strong { color: #FFFFFF; font-weight: 600; }
        .start-screen button {
            margin-top: 30px; background: #FFA500; color: #0F0F0F;
            border: none; padding: 15px 40px; border-radius: 30px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .start-screen button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,165,0,0.4); }
        .chat-interface { display: flex; flex-direction: column; height: 100%; min-height: 0; }
        .chat-messages {
            flex: 0 1 auto; max-height: 250px; overflow-y: auto;
            padding: 20px; padding-bottom: 10px; background: #0F0F0F;
            min-height: 150px; transition: max-height 1.5s ease;
        }
        .chat-messages.expanded { flex: 1; max-height: none; }
        .message { margin-bottom: 15px; display: flex; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.bot { justify-content: flex-start; }
        .message.user { justify-content: flex-end; }
        .message-content {
            max-width: 75%; padding: 12px 16px; border-radius: 18px;
            word-wrap: break-word; font-family: 'Inter', sans-serif;
            font-size: 15px; font-weight: 400; line-height: 1.5;
        }
        .message.bot .message-content {
            background: #1A1A1A; color: #FFFFFF; border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .message.bot .message-content strong { color: #FFA500; font-weight: 600; }
        .message.bot .message-content em { color: #E8E8E8; font-weight: 400; }
        .message.bot .message-content a { color: #FFA500; font-weight: 500; }
        .message.user .message-content {
            background: #FFA500; color: #0F0F0F;
            border-bottom-right-radius: 4px; font-weight: 500;
        }
        .typing-indicator {
            display: none; padding: 12px 16px; background: #1A1A1A;
            border-radius: 18px; width: fit-content; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .typing-indicator span {
            height: 8px; width: 8px; background: #FFA500; border-radius: 50%;
            display: inline-block; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .chat-input-area {
            padding: 10px 15px 5px 15px; background: #1A1A1A;
            border-top: 1px solid #2A2A2A; flex-shrink: 0;
        }
        .gallon-buttons { display: none; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .gallon-btn {
            padding: 12px; background: #FFA500; color: #0F0F0F;
            border: none; border-radius: 15px; cursor: pointer;
            font-size: 15px; font-weight: 600; font-family: 'Inter', sans-serif;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .gallon-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(255,165,0,0.4); }
        .gallon-btn:active { transform: scale(0.98); }
        .diagram-btn {
            display: block; width: 100%; margin: 10px 0 4px 0;
            padding: 12px; background: #FFA500; color: #0F0F0F;
            border: none; border-radius: 15px; cursor: pointer;
            font-size: 15px; font-weight: 600; font-family: 'Inter', sans-serif;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .diagram-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(255,165,0,0.5); }
        .message.bot .message-content a.spec-btn {
            padding: 8px 16px; background: #FFA500; color: #0F0F0F !important;
            border: none; border-radius: 15px; cursor: pointer; font-size: 13px;
            font-weight: 600 !important; font-family: 'Inter', sans-serif;
            transition: transform 0.2s, box-shadow 0.2s; text-decoration: none;
            display: inline-block; margin-right: 8px; margin-top: 8px;
        }
        .message.bot .message-content a.spec-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(255,165,0,0.4); color: #0F0F0F !important; }
        .message.bot .message-content a.spec-btn:active { transform: scale(0.98); }
        .input-group { display: flex; gap: 10px; margin-bottom: 0; }
        #userInput {
            flex: 1; padding: 12px 15px; border: 2px solid #2A2A2A;
            background: #0F0F0F; color: #FFFFFF; border-radius: 25px;
            font-size: 16px; font-weight: 400; font-family: 'Inter', sans-serif;
            outline: none; transition: border-color 0.3s;
        }
        #userInput::placeholder { color: #E8E8E8; font-weight: 400; }
        #userInput:focus { border-color: #FFA500; }
        #sendBtn {
            background: #FFA500; color: #0F0F0F; border: none; padding: 12px 24px;
            border-radius: 25px; cursor: pointer; font-weight: 600;
            font-family: 'Inter', sans-serif; font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s; flex-shrink: 0;
        }
        #sendBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,165,0,0.4); }
        #sendBtn:active { transform: translateY(0); }
        .hidden { display: none !important; }
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(14deg); }
            20%, 40%, 60%, 80% { transform: rotate(-8deg); }
        }
        .wave-emoji { display: inline-block; animation: wave 2s ease-in-out; transform-origin: 70% 70%; font-size: 28px; }
        .checkmark { color: #00E676; }
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: #1A1A1A; }
        .chat-messages::-webkit-scrollbar-thumb { background: #FFA500; border-radius: 4px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #E65100; }
        @media (max-width: 600px) {
            .message.bot, .message.user { justify-content: flex-start; }
            .message-content { max-width: 95%; }
            .message.user .message-content { margin-left: auto; }
        }
        @media (max-width: 600px) {
            .chat-header { padding: 12px 14px; }
            .header-logo-img { height: 28px; }
            .chat-header h1 { font-size: 20px; }
            .chat-header p { font-size: 13px; }
        }
        @media (max-width: 600px) { .chat-messages { padding-left: 10px; padding-right: 10px; } }
        @media (max-width: 600px) { body { padding: 10px; } .chat-container { max-width: 100%; } }
</style>
    <script>
        if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; }
        window.scrollTo(0, 0);
        document.addEventListener('DOMContentLoaded', function() {
            window.scrollTo(0, 0); document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
            const startScreen = document.querySelector('.start-screen');
            if (startScreen) { startScreen.scrollTop = 0; }
        });
        window.addEventListener('load', function() {
            setTimeout(function() {
                window.scrollTo(0, 0); document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
                const startScreen = document.querySelector('.start-screen');
                if (startScreen) { startScreen.scrollTop = 0; }
            }, 0);
        });
    </script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-logo">
                <img src="/Logo.svg" alt="iSolar Hot Water Academy" class="header-logo-img">
            </div>
            <h1>‚òÄÔ∏è PV Solar Hot Water Designer</h1>
            <p>International Support - Metric &amp; Imperial</p>
        </div>
        <div id="startScreen" class="start-screen">
            <h2>Welcome to Your Photovoltaic Hot Water System Designer!</h2>
            <p><strong>I'll help you design a solar electric water heater.</strong></p>
            <p>This takes about 2 minutes.</p>
            <p>Let's get started!</p>
            <button onclick="startChat()">Start Calculator</button>
            <p style="font-size: 13px; color: #E8E8E8; margin-top: 30px; line-height: 1.5; max-width: 500px;">
                Modeling estimates solar hot water using local solar radiation and groundwater temperature. <strong>It targets 75‚Äì85% of annual hot-water demand from solar</strong> for balance of cost and performance.
            </p>
            <p style="font-size: 13px; color: #E8E8E8; line-height: 1.5; max-width: 500px;">
                You can select annual or seasonal averages, or enter your own custom values.<br>
                The goal is to provide a practical starting point for system sizing rather than detailed hour-by-hour or day-by-day performance modeling.
            </p>
        </div>
        <div id="chatInterface" class="chat-interface hidden">
            <div class="chat-messages" id="chatMessages">
                <div class="typing-indicator" id="typingIndicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
            <div class="chat-input-area" id="chatInputArea">
                <div id="gallonButtons" class="gallon-buttons"></div>
                <div id="scenarioButtons" class="gallon-buttons"></div>
                <div class="input-group">
                    <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off">
                    <button id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://solar-calculator-proxy.vercel.app/api/webhook-proxy';

        // ‚îÄ‚îÄ ADDITION 1: openDiagram function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openDiagram(inverterModel, inverterCount, panelCount, panelWattage, elementSize, tankSize, kwhDay, kwhDayMax, optionalTank) {
            const params = new URLSearchParams({
                inverterModel: inverterModel,
                inverterCount: inverterCount,
                panelCount: panelCount,
                panelWattage: panelWattage,
                elementSize: elementSize,
                tankSize: tankSize,
                kwhDay: kwhDay,
                kwhDayMax: kwhDayMax || kwhDay,
                optionalTank: optionalTank || '',
                gridType: 'off-grid',
                userLocation: userData.location || '',
                peakSunHours: lastAps || '',
                season: userData.season || (userData.useAIClimate ? 'annual' : 'custom')
            });
            window.open('/diagram/installation.html?' + params.toString(), '_blank');
        }

        function redirectToWaitlist() {
            const urlParams = new URLSearchParams(window.location.search);
            const userEmail = urlParams.get('email') || 'unknown@example.com';
            window.location.href = '/waitlist/diy.html?email=' + encodeURIComponent(userEmail) + '&avatar=diy';
        }

        let conversationStep = 0;
        let userData = { season: '', useAIClimate: false };
        let estimatedAnnualSun = 5.5;
        let estimatedAnnualColdWater = 68;
        let unitSystem = '';
        let pendingLocation = '';
        let tryCount = parseInt(localStorage.getItem('calculatorTries') || '0');
        // ‚îÄ‚îÄ ADDITION 2: lastAps variable ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let lastAps = 5.5;

        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const gallonButtons = document.getElementById('gallonButtons');
        const chatInputArea = document.getElementById('chatInputArea');

        const metricTankConversions = { 80:20, 150:40, 200:52, 250:66, 300:79, 400:105, 500:132 };

        const stateAbbreviations = {
            'al':'Alabama','ak':'Alaska','az':'Arizona','ar':'Arkansas','ca':'California',
            'co':'Colorado','ct':'Connecticut','de':'Delaware','fl':'Florida','ga':'Georgia',
            'hi':'Hawaii','id':'Idaho','il':'Illinois','in':'Indiana','ia':'Iowa',
            'ks':'Kansas','ky':'Kentucky','la':'Louisiana','me':'Maine','md':'Maryland',
            'ma':'Massachusetts','mi':'Michigan','mn':'Minnesota','ms':'Mississippi','mo':'Missouri',
            'mt':'Montana','ne':'Nebraska','nv':'Nevada','nh':'New Hampshire','nj':'New Jersey',
            'nm':'New Mexico','ny':'New York','nc':'North Carolina','nd':'North Dakota','oh':'Ohio',
            'ok':'Oklahoma','or':'Oregon','pa':'Pennsylvania','ri':'Rhode Island','sc':'South Carolina',
            'sd':'South Dakota','tn':'Tennessee','tx':'Texas','ut':'Utah','vt':'Vermont',
            'va':'Virginia','wa':'Washington','wv':'West Virginia','wi':'Wisconsin','wy':'Wyoming',
            'dc':'District of Columbia'
        };

        const countryCorrections = {
            'uk':'United Kingdom','usa':'United States','us':'United States',
            'uae':'United Arab Emirates','nz':'New Zealand','au':'Australia',
            'sa':'South Africa','can':'Canada','mex':'Mexico','ger':'Germany',
            'fra':'France','esp':'Spain','ita':'Italy','jpn':'Japan','chn':'China',
            'ind':'India','bra':'Brazil','arg':'Argentina',
            'united kingdom':'United Kingdom','united states':'United States',
            'south africa':'South Africa','new zealand':'New Zealand',
            'united arab emirates':'United Arab Emirates'
        };

        const cityDatabase = [
            'San Jose','San Francisco','Los Angeles','San Diego','San Antonio','Santa Fe',
            'New York','Las Vegas','Phoenix','Houston','Philadelphia','Chicago','Dallas',
            'Austin','Seattle','Portland','Denver','Boston','Miami','Atlanta','Detroit',
            'Minneapolis','Tampa','Orlando','Charlotte','Nashville','Pittsburgh','Cincinnati',
            'Cleveland','Milwaukee','Kansas City','Salt Lake City','Oklahoma City','New Orleans',
            'Memphis','Louisville','Baltimore','Albuquerque','Sacramento','Indianapolis',
            'Fort Worth','El Paso','Virginia Beach','Raleigh','Tucson',
            'London','Manchester','Birmingham','Liverpool','Edinburgh',
            'Paris','Lyon','Marseille','Nice','Toulouse',
            'Berlin','Munich','Hamburg','Frankfurt','Cologne',
            'Madrid','Barcelona','Valencia','Seville','Bilbao',
            'Rome','Milan','Naples','Turin','Florence',
            'Tokyo','Osaka','Kyoto','Yokohama','Nagoya',
            'Beijing','Shanghai','Guangzhou','Shenzhen','Chengdu',
            'Sydney','Melbourne','Brisbane','Perth','Adelaide',
            'Toronto','Montreal','Vancouver','Calgary','Ottawa',
            'Mumbai','Delhi','Bangalore','Kolkata','Chennai',
            'Mexico City','Guadalajara','Monterrey','Cancun','Tijuana',
            'Dubai','Abu Dhabi','Doha','Riyadh','Jeddah',
            'Amsterdam','Brussels','Vienna','Copenhagen','Stockholm',
            'Oslo','Helsinki','Warsaw','Prague','Budapest',
            'Lisbon','Athens','Istanbul','Moscow','St Petersburg',
            'Cape Town','Johannesburg','Durban','Pretoria',
            'Buenos Aires','Sao Paulo','Rio de Janeiro','Lima','Bogota',
            'Santiago','Caracas','Havana','San Juan'
        ];

        function similarityScore(str1, str2) {
            str1 = str1.toLowerCase(); str2 = str2.toLowerCase();
            if (str1 === str2) return 100;
            if (str1.includes(str2) || str2.includes(str1)) return 90;
            let matches = 0, str1Idx = 0;
            for (let i = 0; i < str2.length; i++) {
                while (str1Idx < str1.length && str1[str1Idx] !== str2[i]) { str1Idx++; }
                if (str1Idx < str1.length) { matches++; str1Idx++; }
            }
            return (matches / Math.max(str1.length, str2.length)) * 100;
        }

        function findBestCityMatch(input) {
            let bestMatch = null, bestScore = 0;
            for (let city of cityDatabase) {
                const score = similarityScore(city, input);
                if (score > bestScore && score >= 60) { bestScore = score; bestMatch = city; }
            }
            return bestMatch;
        }

        function parseAndCorrectLocation(input) {
            let corrected = input.trim().toLowerCase();
            let parts = corrected.split(/,/).map(p => p.trim()).filter(p => p.length > 0);
            if (parts.length === 0) return input;
            let allParts = [];
            parts.forEach(part => { allParts = allParts.concat(part.split(/\s+/).filter(p => p.length > 0)); });
            let city = '', state = '', country = '';
            if (allParts.length >= 2 && allParts[allParts.length-1].length === 2) {
                const sa = allParts[allParts.length-1].toLowerCase();
                if (stateAbbreviations[sa]) { state = stateAbbreviations[sa]; allParts.pop(); }
            }
            if (!state && allParts.length >= 2) {
                const lp = allParts[allParts.length-1].toLowerCase();
                const ms = Object.values(stateAbbreviations).find(s => s.toLowerCase() === lp);
                if (ms) { state = ms; allParts.pop(); }
            }
            if (!state && allParts.length >= 1) {
                const lp = allParts[allParts.length-1].toLowerCase();
                if (countryCorrections[lp]) { country = countryCorrections[lp]; allParts.pop(); }
                else {
                    const cc = ['canada','mexico','japan','china','india','australia','germany','france','spain','italy','brazil','argentina','england','ireland','scotland','wales'];
                    if (cc.includes(lp)) { country = lp.charAt(0).toUpperCase() + lp.slice(1); allParts.pop(); }
                }
            }
            city = allParts.join(' ');
            const mc = findBestCityMatch(city);
            if (mc) { city = mc; }
            else { city = city.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' '); }
            if (state) return city + ', ' + state;
            else if (country) return city + ', ' + country;
            else return city;
        }

        function fahrenheitToCelsius(f) { return (f - 32) * 5/9; }

        function getOptimalConditionsMessage(direction) {
            return '<em><strong>Results shown reflect optimal conditions.</strong><br>Panels face within 35¬∞ of due ' + direction + ', are tilted at an angle within ¬±15¬∞ of your site\'s latitude, and free from shading 9am - 3pm.</em><br><br>';
        }

        function calculateOptimalMetricTank(dailyGallons, setpointF, highLimitF, incomingF) {
            const mg = [20,40,52,66,79,105,132], ml = [80,150,200,250,300,400,500];
            const min = (dailyGallons * (setpointF - incomingF) / 1.05) / (highLimitF - incomingF);
            for (let i = 0; i < mg.length; i++) { if (mg[i] >= min) return ml[i]; }
            return 500;
        }

        function calculateOptimalImperialTank(dailyGallons, setpointF, highLimitF, incomingF) {
            const ig = [20,30,40,50,65,80,105,120];
            const min = (dailyGallons * (setpointF - incomingF) / 1.05) / (highLimitF - incomingF);
            for (let i = 0; i < ig.length; i++) { if (ig[i] >= min) return ig[i]; }
            return 120;
        }

        function gallonsToExactLiters(gallons) {
            const t = {40:150,52:200,66:250,79:300,105:400,132:500};
            return t[Math.round(gallons)] || Math.round(gallons * 3.78541);
        }

        // DIY marketing block ‚Äî reused across all result scenarios
        const diyMarketing = `<div style="background:#FFFFFF;padding:30px;margin-top:20px;border-radius:10px;">
            <strong style="color:#FF8C00;font-size:17px;display:block;margin-bottom:2px;">HANDY HOMEOWNERS</strong>
            <em style="color:#000000;font-size:13px;display:block;">Install and save big</em><br>
            <strong style="color:#000000;font-size:16px;">Skip $6,000 in contractor overhead and put that money in your pocket.</strong><br><br>
            <strong style="color:#000000;font-size:16px;">Imagine a simple solar project</strong><br>
            <strong style="color:#000000;font-size:16px;">you can take on yourself!</strong><br><br>
            <em style="color:#000000;">Join the way how handy homeowners earn thousands more doing it themselves.</em><br><br>
            <strong style="color:#000000;">Make it happen</strong><br>
            <button class="gallon-btn" onclick="redirectToWaitlist();return false;" style="margin-top:10px;background:#00E676;color:#000000;">Continue</button><br>
            <div style="text-align:center;margin-top:30px;">
                <strong style="color:#E65100;font-size:17px;">Click the video to learn more.</strong><br>
                <em style="color:#000000;font-size:13px;">The best PV water heater is here!</em><br>
                <a href="https://youtu.be/TI5WKT8yeNU" target="_blank">
                    <img src="/calc/NewPVThmb.jpeg" alt="PV Water Heating Video" style="max-width:350px;width:100%;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.3);cursor:pointer;transition:transform 0.2s;margin-top:5px;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                </a>
            </div>
        </div>`;

        function startChat() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            if (tryCount >= 10) {
                addMessage('<strong><span style="color:#00E676;">üéâ</span> You\'ve reached the maximum of 10 calculations!</strong><br>You\'ve explored many scenarios! Ready to take the next step?<br><br>' + diyMarketing);
                return;
            }
            setTimeout(() => {
                addMessage("<strong>Welcome, Homeowners! <span class='wave-emoji'>üëã</span></strong><br><span style='color:#FFFFFF;'>I'm your PV water-heating assistant.<br>üéØ There's a bonus waiting at the end.</span>");
                setTimeout(() => {
                    addMessage('<strong>Which units do you prefer?<br>Click a button or enter</strong><br>‚Ä¢ <strong>"Imperial"</strong> for US units (gallons, ¬∞F)<br>‚Ä¢ <strong>"Metric"</strong> for international units (liters, ¬∞C)');
                    const ub = document.getElementById('gallonButtons');
                    ub.innerHTML = '<button class="gallon-btn" onclick="selectUnitSystem(\'imperial\')">Imperial</button><button class="gallon-btn" onclick="selectUnitSystem(\'metric\')">Metric</button>';
                    ub.style.display = 'grid'; ub.style.gridTemplateColumns = 'repeat(2,1fr)';
                    conversationStep = 0.5; chatMessages.scrollTop = 0; userInput.focus();
                }, 1000);
            }, 500);
        }

        function selectUnitSystem(system) {
            addMessage(system.charAt(0).toUpperCase() + system.slice(1), true);
            document.getElementById('gallonButtons').style.display = 'none';
            setTimeout(() => { showTyping(); setTimeout(() => { hideTyping(); processMessage(system); }, 800); }, 300);
        }

        function addMessage(text, isUser = false) {
            const md = document.createElement('div');
            md.className = 'message ' + (isUser ? 'user' : 'bot');
            const cd = document.createElement('div');
            cd.className = 'message-content'; cd.innerHTML = text;
            md.appendChild(cd); chatMessages.appendChild(md);
            if (chatMessages.querySelectorAll('.message').length >= 9) { chatMessages.classList.add('expanded'); }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping() { typingIndicator.style.display = 'block'; chatMessages.scrollTop = chatMessages.scrollHeight; }
        function hideTyping() { typingIndicator.style.display = 'none'; }

        function selectWaterAmount(amount) {
            if (unitSystem === 'metric') { userData.gallons = metricTankConversions[amount]; addMessage(amount + ' liters', true); }
            else { userData.gallons = amount; addMessage(amount + ' gallons', true); }
            gallonButtons.style.display = 'none'; userInput.focus();
            setTimeout(() => {
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    addMessage('Perfect! ' + (unitSystem === 'metric' ? amount + ' liters' : amount + ' gallons') + ' per day.');
                    setTimeout(() => {
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addMessage('<strong>Choose your solar energy modeling scenario. Click a button or enter</strong><br><br>‚Ä¢ Type <strong>"annual"</strong> for year-round average conditions<br>‚Ä¢ Type a season, <strong>"winter"</strong>, <strong>"spring"</strong>, <strong>"summer"</strong>, <strong>"fall"</strong> for seasonal conditions<br>‚Ä¢ Type <strong>"custom"</strong> to enter your own specific values<br><br>Need help deciding? Type <strong>"help"</strong> for guidance!');
                            const sb = document.getElementById('scenarioButtons');
                            sb.innerHTML = '<button class="gallon-btn" onclick="selectScenario(\'annual\')" style="font-weight:700;">Annual</button><button class="gallon-btn" onclick="selectScenario(\'custom\')">Custom</button><button class="gallon-btn" onclick="selectScenario(\'help\')">Help</button><button class="gallon-btn" onclick="selectScenario(\'spring\')">Spring</button><button class="gallon-btn" onclick="selectScenario(\'summer\')">Summer</button><button class="gallon-btn" onclick="selectScenario(\'fall\')">Fall</button><button class="gallon-btn" onclick="selectScenario(\'winter\')">Winter</button>';
                            sb.style.display = 'grid'; chatMessages.scrollTop = chatMessages.scrollHeight;
                            conversationStep = 3; userInput.focus();
                        }, 800);
                    }, 500);
                }, 800);
            }, 300);
        }

        function selectScenario(scenario) {
            addMessage(scenario.charAt(0).toUpperCase() + scenario.slice(1), true);
            document.getElementById('scenarioButtons').style.display = 'none';
            setTimeout(() => { showTyping(); setTimeout(() => { hideTyping(); processMessage(scenario); }, 800); }, 300);
        }

        function copyResults() {
            const msgs = chatMessages.querySelectorAll('.message.bot .message-content');
            const last = msgs[msgs.length - 1];
            if (!last) return;
            const tmp = document.createElement('div');
            tmp.innerHTML = last.innerHTML;
            const all = tmp.querySelectorAll('*');
            let found = false;
            for (let i = 0; i < all.length; i++) {
                if (all[i].textContent.includes('Results shown reflect optimal conditions')) {
                    found = true;
                    let ns = all[i].nextSibling;
                    while (ns) { const r = ns; ns = ns.nextSibling; if (r.parentNode) r.parentNode.removeChild(r); }
                    break;
                }
                if (found) all[i].remove();
            }
            tmp.querySelectorAll('button').forEach(b => b.remove());
            tmp.querySelectorAll('hr').forEach(h => h.remove());
            let txt = tmp.innerText.trim().replace(/\n\s*\n\s*\n/g,'\n\n').replace(/\n{3,}/g,'\n\n');
            navigator.clipboard.writeText(txt).then(() => alert('Results copied to clipboard!')).catch(() => alert('Copy failed. Please select and copy manually.'));
        }

        function tryAgain() {
            tryCount++; localStorage.setItem('calculatorTries', tryCount.toString());
            if (tryCount === 5) { addMessage('<strong>üéØ You\'ve completed 5 calculations!</strong><br><br>Want to explore more scenarios? You have <strong>5 more tries</strong> to refine your system design!<br><br><button class="gallon-btn" onclick="continueCalculating()" style="margin-top:10px;">5 More</button>'); return; }
            if (tryCount >= 10) { addMessage('<strong>üéâ You\'ve reached the maximum of 10 calculations!</strong><br><br>You\'ve explored many scenarios! Ready to take the next step?<br><br><em>Time to move forward with your solar hot water system design.</em><br><br><strong>The calculator will now be locked. Contact us to continue or clear your browser data to reset.</strong>'); return; }
            location.reload();
        }

        function continueCalculating() { location.reload(); }

        sendBtn.addEventListener('click', handleUserInput);
        userInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleUserInput(); });
        userInput.addEventListener('input', () => {
            const gb = document.getElementById('gallonButtons'), sb = document.getElementById('scenarioButtons');
            if (gb.style.display === 'grid' && (conversationStep === 0.5 || conversationStep === 2)) gb.style.display = 'none';
            if (sb.style.display === 'grid' && conversationStep === 3) sb.style.display = 'none';
        });

        async function handleUserInput() {
            const msg = userInput.value.trim();
            if (!msg) return;
            addMessage(msg, true); userInput.value = '';
            showTyping();
            setTimeout(async () => { hideTyping(); await processMessage(msg); }, 800);
        }

        async function processMessage(message) {
            switch (conversationStep) {
                case 0.5:
                    const ch = message.toLowerCase();
                    if (ch === 'metric' || ch === 'm') {
                        unitSystem = 'metric';
                        addMessage("Fantastic! We'll use metric units (liters and Celsius).");
                        setTimeout(() => { addMessage("<strong>What's your location?</strong> (City, State/Country)"); conversationStep = 1; userInput.focus(); }, 800);
                    } else if (ch === 'imperial' || ch === 'i') {
                        unitSystem = 'imperial';
                        addMessage("Great! We'll use imperial units (gallons and Fahrenheit).");
                        setTimeout(() => { addMessage("<strong>What's your location?</strong> (City, State/Country)"); conversationStep = 1; userInput.focus(); }, 800);
                    } else { addMessage('Please type <strong>"metric"</strong> or <strong>"imperial"</strong>.'); userInput.focus(); }
                    break;

                case 1:
                    pendingLocation = parseAndCorrectLocation(message);
                    addMessage('Is your location <strong>' + pendingLocation + '</strong>? Type <strong>"yes"</strong> or enter your location again.');
                    conversationStep = 1.5; userInput.focus();
                    break;

                case 1.5:
                    const conf = message.toLowerCase();
                    if (conf === 'yes' || conf === 'y') {
                        userData.location = pendingLocation;
                        addMessage('Got it! ' + pendingLocation + '.');
                        setTimeout(() => {
                            showTyping();
                            setTimeout(() => {
                                hideTyping();
                                const uNote = unitSystem === 'metric' ? 'Note: Most consumers use 60-75 liters per person of hot water each day. Usage varies by individual.' : 'Note: Most consumers use 15-20 gallons per person of hot water each day. Usage varies by individual.';
                                const wQ = unitSystem === 'metric' ? 'How many liters of hot water does your household use each day?' : 'How many gallons of hot water does your household use each day?';
                                addMessage('<strong>Perfect!<br>' + wQ + '</strong><br><br><em>' + uNote + '</em>');
                                setTimeout(() => {
                                    showTyping();
                                    setTimeout(() => {
                                        hideTyping();
                                        addMessage('<strong>Select amount from a button or enter</strong>');
                                        if (unitSystem === 'metric') {
                                            gallonButtons.innerHTML = '<button class="gallon-btn" onclick="selectWaterAmount(150)">150 L</button><button class="gallon-btn" onclick="selectWaterAmount(200)">200 L</button><button class="gallon-btn" onclick="selectWaterAmount(250)">250 L</button><button class="gallon-btn" onclick="selectWaterAmount(300)">300 L</button><button class="gallon-btn" onclick="selectWaterAmount(400)">400 L</button><button class="gallon-btn" onclick="selectWaterAmount(500)">500 L</button>';
                                        } else {
                                            gallonButtons.innerHTML = '<button class="gallon-btn" onclick="selectWaterAmount(20)">20 gal</button><button class="gallon-btn" onclick="selectWaterAmount(30)">30 gal</button><button class="gallon-btn" onclick="selectWaterAmount(40)">40 gal</button><button class="gallon-btn" onclick="selectWaterAmount(50)">50 gal</button><button class="gallon-btn" onclick="selectWaterAmount(60)">60 gal</button><button class="gallon-btn" onclick="selectWaterAmount(80)">80 gal</button><button class="gallon-btn" onclick="selectWaterAmount(100)">100 gal</button><button class="gallon-btn" onclick="selectWaterAmount(120)">120 gal</button>';
                                        }
                                        gallonButtons.style.display = 'grid';
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                        conversationStep = 2; userInput.focus();
                                    }, 800);
                                }, 500);
                            }, 1000);
                        }, 500);
                    } else {
                        pendingLocation = parseAndCorrectLocation(message);
                        addMessage('Is your location <strong>' + pendingLocation + '</strong>? Type <strong>"yes"</strong> or enter your location again.');
                        userInput.focus();
                    }
                    break;

                case 2:
                    const amt = parseFloat(message);
                    if (unitSystem === 'metric') {
                        if ([150,200,250,300,400,500].includes(Math.round(amt))) { selectWaterAmount(Math.round(amt)); }
                        else { addMessage('Please click a button or enter a standard amount (150, 200, 250, 300, 400, or 500 liters)'); userInput.focus(); }
                    } else {
                        if ([20,30,40,50,60,80,100,120].includes(Math.round(amt))) { selectWaterAmount(Math.round(amt)); }
                        else { addMessage('Please click a button or enter: 20, 30, 40, 50, 60, 80, 100, or 120'); userInput.focus(); }
                    }
                    break;

                case 3:
                    const sc = message.toLowerCase().trim();
                    document.getElementById('scenarioButtons').style.display = 'none';
                    if (sc === 'help') {
                        addMessage('<strong>üìö MODELING SCENARIOS EXPLAINED:</strong><br><br><strong>"Annual"</strong><br>Annual sizing uses year-round average solar radiation and groundwater temperature at your location. This provides a balanced system that performs well most of the year. Choose <strong>"annual"</strong> if the system will be used year-round. It is the most common and cost-effective approach for most homes.<br><br><strong>Seasonal</strong><br><strong>("Winter", "Spring", "Summer", "Fall")</strong><br>Seasonal sizing uses climate data for a specific time of year. Choose this option when hot water demand occurs primarily during one season. For example, choosing "Summer" is ideal for a cabin or resort that operates mainly in warmer months, making the system more economical. Winter sizing is generally not recommended, as shorter days and lower solar radiation in latitudes farther from the equator would require a much larger array‚Äîoften 40‚Äì80% larger than what is needed for most of the year.<br><br><strong>"Custom"</strong><br>Custom sizing allows you to manually enter your own peak sun hours and cold-water temperature values. Select <strong>"custom"</strong> if you have unique data for your site or want to model a specific scenario. This gives you full control over the sizing inputs and performance assumptions.<br><br>Now, which scenario would you like? Type <strong>"annual"</strong>, <strong>"winter"</strong>, <strong>"spring"</strong>, <strong>"summer"</strong>, <strong>"fall"</strong>, or <strong>"custom"</strong>.');
                        userInput.focus(); return;
                    }
                    if (sc === 'annual') {
                        userData.season = ''; userData.useAIClimate = true;
                        addMessage("Great choice! I'll use year-round average climate data for your location.");
                        setTimeout(() => { showTyping(); setTimeout(() => { hideTyping();
                            const dt = unitSystem==='metric'?'50¬∞C':'120¬∞F', st = unitSystem==='metric'?'55¬∞C':'130¬∞F', tr = unitSystem==='metric'?'38-60¬∞C':'100-140¬∞F';
                            addMessage('<strong>Enter the \'Setpoint\' hot water temperature.</strong><br><strong>' + dt + ' is recommended to prevent scalding risk.</strong> Temperatures above ' + st + ' can cause serious burns in seconds, especially for children and elderly. Enter your desired hot water temperature (' + tr + ').');
                            conversationStep = 4; userInput.focus();
                        }, 800); }, 500);
                    } else if (['winter','spring','summer','fall'].includes(sc)) {
                        userData.season = sc; userData.useAIClimate = true;
                        addMessage('Excellent! I\'ll use ' + sc + ' climate data for your location.');
                        setTimeout(() => { showTyping(); setTimeout(() => { hideTyping();
                            const dt = unitSystem==='metric'?'50¬∞C':'120¬∞F', st = unitSystem==='metric'?'55¬∞C':'130¬∞F', tr = unitSystem==='metric'?'38-60¬∞C':'100-140¬∞F';
                            addMessage('<strong>Enter the \'Setpoint\' hot water temperature.</strong><br><strong>' + dt + ' is recommended to prevent scalding risk.</strong> Temperatures above ' + st + ' can cause serious burns in seconds, especially for children and elderly. Enter your desired hot water temperature (' + tr + ').');
                            conversationStep = 4; userInput.focus();
                        }, 800); }, 500);
                    } else if (sc === 'custom') {
                        userData.season = ''; userData.useAIClimate = false;
                        addMessage("Got it! I'll use your custom values.");
                        setTimeout(() => { showTyping(); setTimeout(() => { hideTyping();
                            addMessage('Great! What are your peak sun hours per day? (2-9)<br><br>Type <strong>"help"</strong> if you need more information.');
                            conversationStep = 3.1; userInput.focus();
                        }, 800); }, 500);
                    } else {
                        addMessage('Please type <strong>"annual"</strong>, a season (<strong>"winter"</strong>, <strong>"spring"</strong>, <strong>"summer"</strong>, <strong>"fall"</strong>), <strong>"custom"</strong>, or <strong>"help"</strong>.');
                        userInput.focus();
                    }
                    break;

                case 3.1:
                    if (message.toLowerCase().trim() === 'help') {
                        addMessage('<strong>üìö PEAK SUN HOURS EXPLAINED:</strong><br><br>Peak sun hours measure the equivalent hours per day of full-strength sunlight (1,000 W/m¬≤)‚Äînot total daylight hours. Most U.S. locations average 3-7 peak sun hours. Find your location\'s data at pvwatts.nrel.gov or similar solar databases.<br><br>Now, please enter your peak sun hours (2-9).');
                        userInput.focus(); return;
                    }
                    const ps = parseFloat(message);
                    if (!isNaN(ps) && ps >= 2 && ps <= 9) {
                        userData.peakSunHours = ps;
                        addMessage('Fantastic! ' + ps + ' peak sun hours per day.');
                        setTimeout(() => { showTyping(); setTimeout(() => { hideTyping();
                            const tr = unitSystem==='metric'?'4-27¬∞C':'40-80¬∞F';
                            addMessage('What is your cold water temperature? (' + tr + ')<br><br>Type <strong>"help"</strong> if you need more information.');
                            conversationStep = 3.2; userInput.focus();
                        }, 800); }, 500);
                    } else { addMessage('Please enter a number between 2 and 9 for peak sun hours, or type <strong>"help"</strong> for more information.'); userInput.focus(); }
                    break;

                case 3.2:
                    if (message.toLowerCase().trim() === 'help') {
                        const tr32 = unitSystem==='metric'?'4-27¬∞C':'40-80¬∞F';
                        addMessage('<strong>üìö COLD WATER TEMPERATURE EXPLAINED:</strong><br><br>Cold water temperature is your incoming water supply temperature from underground pipes. It affects how much energy is needed to heat your water. Most locations average 40-80¬∞F or 4-27¬∞C annually. Measure it by running cold tap water for a few minutes with a thermometer.<br><br>Now, please enter your cold water temperature (' + tr32 + ').');
                        userInput.focus(); return;
                    }
                    const ct = parseFloat(message);
                    const minT = unitSystem==='metric'?4:40, maxT = unitSystem==='metric'?27:80;
                    if (!isNaN(ct) && ct >= minT && ct <= maxT) {
                        userData.coldWaterTemp = unitSystem==='metric' ? (ct*9/5)+32 : ct;
                        addMessage('OK, good! Cold water at ' + (unitSystem==='metric' ? ct+'¬∞C' : ct+'¬∞F') + '.');
                        setTimeout(() => { showTyping(); setTimeout(() => { hideTyping();
                            const dt = unitSystem==='metric'?'50¬∞C':'120¬∞F', st = unitSystem==='metric'?'55¬∞C':'130¬∞F', tr = unitSystem==='metric'?'38-60¬∞C':'100-140¬∞F';
                            addMessage('<strong>Enter the \'Setpoint\' hot water temperature.</strong><br><strong>' + dt + ' is recommended to prevent scalding risk.</strong> Temperatures above ' + st + ' can cause serious burns in seconds, especially for children and elderly. Enter your desired hot water temperature (' + tr + ').');
                            conversationStep = 4; userInput.focus();
                        }, 800); }, 500);
                    } else {
                        const tr32b = unitSystem==='metric'?'4-27¬∞C':'40-80¬∞F';
                        addMessage('Please enter a temperature between ' + tr32b + ', or type <strong>"help"</strong> for more information.');
                        userInput.focus();
                    }
                    break;

                case 4:
                    const ht = parseFloat(message);
                    const minH = unitSystem==='metric'?38:100, maxH = unitSystem==='metric'?60:140;
                    if (!isNaN(ht) && ht >= minH && ht <= maxH) {
                        userData.hotWaterTemp = unitSystem==='metric' ? (ht*9/5)+32 : ht;
                        addMessage('Perfect! Set to ' + (unitSystem==='metric' ? ht+'¬∞C' : ht+'¬∞F') + '.');
                        setTimeout(() => { showTyping(); setTimeout(() => { hideTyping();
                            addMessage('<strong>Enter the wattage rating of your PV panels.</strong><br>Panels around 400‚Äì450 W are ideal for matching the output of the listed inverters.<br><strong>Choose a value between 250‚Äì550 W.</strong>');
                            conversationStep = 5; userInput.focus();
                        }, 800); }, 500);
                    } else {
                        addMessage('Please enter a temperature between ' + (unitSystem==='metric'?'38-60¬∞C':'100-140¬∞F') + '.');
                        userInput.focus();
                    }
                    break;

                case 5:
                    const wt = parseInt(message);
                    if (!isNaN(wt) && wt >= 250 && wt <= 550) {
                        userData.panelWatts = wt;
                        addMessage('Got it! ' + wt + 'W panels.');
                        setTimeout(() => { showTyping(); setTimeout(() => { hideTyping();
                            const tr5 = unitSystem==='metric'?'50-65¬∞C':'120-150¬∞F';
                            const lT = unitSystem==='metric'?'65¬∞C':'150¬∞F';
                            const wT = unitSystem==='metric' ? '<br><br>‚ö†Ô∏è <strong style="color:#e74c3c;">WARNING:</strong> High limit above 50¬∞C (120¬∞F) requires an anti-scald mixing valve on the water heater.' : '<br><br>‚ö†Ô∏è <strong style="color:#e74c3c;">WARNING:</strong> High limit above 120¬∞F requires an anti-scald mixing valve on the water heater.';
                            addMessage('<strong>Enter the high-limit temperature for the water heater.</strong> Setting a high limit to ' + lT + ' enables smaller tank sizing by storing water at higher temperatures. Smaller tank = lower cost, easier retrofit, and less space required. You get the same daily hot water at your desired temperature, just from a smaller tank. <strong>Choose between ' + tr5 + '.</strong>' + wT);
                            conversationStep = 6; userInput.focus();
                        }, 800); }, 500);
                    } else { addMessage('Please enter a wattage between 250 and 550.'); userInput.focus(); }
                    break;

                case 6:
                    const hl = parseFloat(message);
                    const minL = unitSystem==='metric'?50:120, maxL = unitSystem==='metric'?65:150;
                    if (!isNaN(hl) && hl >= minL && hl <= maxL) {
                        userData.highLimit = unitSystem==='metric' ? (hl*9/5)+32 : hl;
                        addMessage('Excellent! High limit set to ' + (unitSystem==='metric' ? hl+'¬∞C' : hl+'¬∞F') + '.');
                        setTimeout(() => {
                            addMessage("Perfect! ‚òÄÔ∏è<br>I have all the information I need.<br>‚è≥ Please wait a few moments and I will calculate your results...");
                            setTimeout(() => { showTyping(); sendToWebhook(); }, 1000);
                        }, 500);
                    } else {
                        addMessage('Please enter a high limit between ' + (unitSystem==='metric'?'50-65¬∞C':'120-150¬∞F') + '.');
                        userInput.focus();
                    }
                    break;
            }
        }

        async function sendToWebhook() {
            try {
                const response = await fetch(WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(userData) });
                const data = await response.json();
                hideTyping();
                if (data.success && data.system_1250w && data.system_1500w) { displayResults(data); }
                else { addMessage("I apologize, but I encountered an issue calculating your system. Please try again or contact support."); }
            } catch (error) {
                hideTyping();
                addMessage("Connection error. Please check your internet and try again.");
                console.error('Error:', error);
            }
        }

        function displayResults(data) {
            chatInputArea.style.display = 'none';
            const sys1250 = data.system_1250w, sys1500 = data.system_1500w;
            if (!sys1250.inverters || sys1250.inverters === null || sys1250.inverters === 'null') { displaySingleSystem(data, sys1500, '1500H'); return; }
            const e1250 = typeof sys1250.panels === 'string' && sys1250.panels.toLowerCase().includes('exceeds');
            const e1500 = typeof sys1500.panels === 'string' && sys1500.panels.toLowerCase().includes('exceeds');
            if (e1250 && e1500) {
                const aps = data.peak_sun_hours_actual || userData.peakSunHours || estimatedAnnualSun;
                const dg = unitSystem==='metric' ? gallonsToExactLiters(parseFloat(userData.gallons)) : Math.round(userData.gallons);
                const dht = unitSystem==='metric' ? Math.round(fahrenheitToCelsius(parseFloat(userData.hotWaterTemp))) : Math.round(userData.hotWaterTemp);
                addMessage('<strong>‚ö†Ô∏è System Cannot Produce Required Energy</strong><br><br>The system cannot provide sufficient energy for your hot water specifications:<br><br>‚Ä¢ Daily Usage: ' + dg + ' ' + (unitSystem==='metric'?'liters':'gallons') + '<br>‚Ä¢ Target Temperature: ' + dht + (unitSystem==='metric'?'¬∞C':'¬∞F') + '<br>‚Ä¢ Peak Sun Hours: ' + aps + ' hrs/day<br>‚Ä¢ Panel Wattage: ' + userData.panelWatts + 'W<br><br><strong>Please try again with a lower hot water temperature and rerun the calculator.</strong><br><br><button class="gallon-btn" onclick="tryAgain()">Try Again</button>');
                return;
            }
            if (e1500 && !e1250) { displaySingleSystem(data, sys1250, '1200H'); return; }
            if (e1250 && !e1500) { displaySingleSystem(data, sys1500, '1500H'); return; }
            displayBothSystems(data);
        }

        function displaySingleSystem(data, system, inverterModel) {
            const aps = data.peak_sun_hours_actual || userData.peakSunHours || estimatedAnnualSun;
            // ‚îÄ‚îÄ ADDITION 3a: store lastAps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            lastAps = aps;
            const act = data.cold_water_temp_actual || userData.coldWaterTemp || estimatedAnnualColdWater;
            const lat = data.latitude_actual || 35;
            const dir = lat < 0 ? 'north' : 'south';

            if (unitSystem === 'metric') {
                const dg = gallonsToExactLiters(parseFloat(userData.gallons));
                const dct = Math.round(fahrenheitToCelsius(act));
                const dht = Math.round(fahrenheitToCelsius(parseFloat(userData.hotWaterTemp)));
                const dhl = Math.round(fahrenheitToCelsius(parseFloat(userData.highLimit)));
                const td = calculateOptimalMetricTank(parseFloat(userData.gallons), parseFloat(userData.hotWaterTemp), parseFloat(userData.highLimit), act);
                const showOpt = parseFloat(userData.highLimit) > parseFloat(userData.hotWaterTemp) && td < dg;
                addMessage(
                    '<strong style="font-size:17px;"><span style="color:#00E676;">‚úÖ</span> Your Solar Hot Water System Results!</strong><br><br>' +
                    'üìç <strong>Location:</strong> ' + userData.location + '<br>' +
                    'üíß <strong>Daily Hot Water:</strong> ' + dg + ' liters<br>' +
                    '‚òÄÔ∏è <strong>Peak Sun Hours:</strong> ' + aps + ' hrs/day<br>' +
                    'üå°Ô∏è <strong>Cold Water Temp:</strong> ' + dct + '¬∞C*<br>' +
                    'üî• <strong>Hot Water Temp:</strong> ' + dht + '¬∞C<br>' +
                    '‚ö° <strong>Panel Wattage:</strong> ' + userData.panelWatts + 'W<br>' +
                    'üìä <strong>High Limit:</strong> ' + dhl + '¬∞C<br><br>' +
                    '<em>*Cold water temperature has a large impact on sizing. If it seems low, measure the temperature at your cold tap, press Try Again, and enter it in Custom Seasonal Settings along with the Peak Sun Hours above.</em><br><br>' +
                    '<strong>üî∑ RECOMMENDED SYSTEM</strong><br><br>' +
                    '<strong>Use the Off-Grid CIM ' + inverterModel + ' Inverter</strong><br>' +
                    '‚Ä¢ Inverters: ' + system.inverters + '<br>' +
                    '‚Ä¢ Panels: ' + system.panels + '<br>' +
                    '‚Ä¢ Panel Wattage: ' + userData.panelWatts + 'W<br>' +
                    '‚Ä¢ Element Size: ' + system.element_size + 'W<br>' +
                    '‚Ä¢ Tank Size: ' + dg + ' liters<br>' +
                    '‚Ä¢ kWh/Day: <span style="color:#00E676;font-weight:600;">' + system.kwh_day + '</span><br>' +
                    (showOpt ? '‚Ä¢ kWh/Day Max: <span style="color:#00E676;font-weight:600;">' + system.kwh_max + '</span><br>*Optional Tank Size: ' + td + ' liters (mixing valve required)<br>' : '') +
                    '<br>This system can meet your hot water requirements.<br><br>' +
                    // ‚îÄ‚îÄ ADDITION 4a: diagram button (metric single) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    '<button class="diagram-btn" onclick="openDiagram(\'CIM ' + inverterModel + '\',\'' + system.inverters + '\',\'' + system.panels + '\',\'' + userData.panelWatts + '\',\'' + system.element_size + '\',\'' + dg + '\',\'' + system.kwh_day + '\',\'' + (system.kwh_max || system.kwh_day) + '\',\'' + (showOpt ? td : '') + '\')">‚ö° How It All Connects</button><br>' +
                    getOptimalConditionsMessage(dir) +
                    '<button class="gallon-btn" onclick="copyResults()" style="margin-right:10px;">Copy Results</button>' +
                    '<button class="gallon-btn" onclick="tryAgain()">Try Again</button><br>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1200H-Spec-Sheet-Rev-6.6-Jan-2024.pdf" target="_blank" class="spec-btn">1200H Spec Sheet</a>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1500H-Spec-Sheet-Rev-6.8-Jan-2025.pdf" target="_blank" class="spec-btn">1500H Spec Sheet</a><br><br>' +
                    diyMarketing
                );
            } else {
                const dg = Math.round(userData.gallons);
                const dct = Math.round(act);
                const dht = Math.round(userData.hotWaterTemp);
                const dhl = Math.round(userData.highLimit);
                const otd = calculateOptimalImperialTank(parseFloat(userData.gallons), parseFloat(userData.hotWaterTemp), parseFloat(userData.highLimit), act);
                const showOpt = parseFloat(userData.highLimit) > parseFloat(userData.hotWaterTemp) && otd < dg;
                addMessage(
                    '<strong style="font-size:17px;"><span style="color:#00E676;">‚úÖ</span> Your Solar Hot Water System Results!</strong><br><br>' +
                    'üìç <strong>Location:</strong> ' + userData.location + '<br>' +
                    'üíß <strong>Daily Hot Water:</strong> ' + dg + ' gallons<br>' +
                    '‚òÄÔ∏è <strong>Peak Sun Hours:</strong> ' + aps + ' hrs/day<br>' +
                    'üå°Ô∏è <strong>Cold Water Temp:</strong> ' + dct + '¬∞F*<br>' +
                    'üî• <strong>Hot Water Temp:</strong> ' + dht + '¬∞F<br>' +
                    '‚ö° <strong>Panel Wattage:</strong> ' + userData.panelWatts + 'W<br>' +
                    'üìä <strong>High Limit:</strong> ' + dhl + '¬∞F<br><br>' +
                    '<em>*Cold water temperature has a large impact on sizing. If it seems low, measure the temperature at your cold tap, press Try Again, and enter it in Custom Seasonal Settings along with the Peak Sun Hours above.</em><br><br>' +
                    '<strong>üî∑ RECOMMENDED SYSTEM</strong><br><br>' +
                    '<strong>Use the Off-Grid CIM ' + inverterModel + ' Inverter</strong><br>' +
                    '‚Ä¢ Inverters: ' + system.inverters + '<br>' +
                    '‚Ä¢ Panels: ' + system.panels + '<br>' +
                    '‚Ä¢ Panel Wattage: ' + userData.panelWatts + 'W<br>' +
                    '‚Ä¢ Element Size: ' + system.element_size + 'W<br>' +
                    '‚Ä¢ Tank Size: ' + dg + ' gallons<br>' +
                    '‚Ä¢ kWh/Day: <span style="color:#00E676;font-weight:600;">' + system.kwh_day + '</span><br>' +
                    (showOpt ? '‚Ä¢ kWh/Day Max: <span style="color:#00E676;font-weight:600;">' + system.kwh_max + '</span><br>*Optional Tank Size: ' + otd + ' gallons (mixing valve required)<br>' : '') +
                    '<br>This system can meet your hot water requirements.<br><br>' +
                    // ‚îÄ‚îÄ ADDITION 4b: diagram button (imperial single) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    '<button class="diagram-btn" onclick="openDiagram(\'CIM ' + inverterModel + '\',\'' + system.inverters + '\',\'' + system.panels + '\',\'' + userData.panelWatts + '\',\'' + system.element_size + '\',\'' + dg + '\',\'' + system.kwh_day + '\',\'' + (system.kwh_max || system.kwh_day) + '\',\'' + (showOpt ? otd : '') + '\')">‚ö° How It All Connects</button><br>' +
                    getOptimalConditionsMessage(dir) +
                    '<button class="gallon-btn" onclick="copyResults()" style="margin-right:10px;">Copy Results</button>' +
                    '<button class="gallon-btn" onclick="tryAgain()">Try Again</button><br>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1200H-Spec-Sheet-Rev-6.6-Jan-2024.pdf" target="_blank" class="spec-btn">1200H Spec Sheet</a>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1500H-Spec-Sheet-Rev-6.8-Jan-2025.pdf" target="_blank" class="spec-btn">1500H Spec Sheet</a><br><br>' +
                    diyMarketing
                );
            }
            setTimeout(() => {
                const msgs = chatMessages.querySelectorAll('.message');
                const last = msgs[msgs.length-1];
                if (last) last.scrollIntoView({ behavior:'smooth', block:'start' });
            }, 100);
        }

        function displayBothSystems(data) {
            const sys1250 = data.system_1250w, sys1500 = data.system_1500w;
            const aps = data.peak_sun_hours_actual || userData.peakSunHours || estimatedAnnualSun;
            // ‚îÄ‚îÄ ADDITION 3b: store lastAps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            lastAps = aps;
            const act = data.cold_water_temp_actual || userData.coldWaterTemp || estimatedAnnualColdWater;
            const lat = data.latitude_actual || 35;
            const dir = lat < 0 ? 'north' : 'south';

            let rec, alt, recName, altName, reason;
            const i1250 = parseInt(sys1250.inverters), i1500 = parseInt(sys1500.inverters);
            const p1250 = parseInt(sys1250.panels), p1500 = parseInt(sys1500.panels);
            if (i1250 < i1500) {
                rec=sys1250; alt=sys1500; recName="Use the Off-Grid CIM 1200H Inverter"; altName="Use the Off-Grid CIM 1500H Inverter";
                reason = p1250<p1500 ? "This system uses fewer inverters and panels, making it more cost-effective and requiring less roof area and is simpler to install." : "This system uses fewer inverters, making it more cost-effective and simpler to install.";
            } else if (i1500 < i1250) {
                rec=sys1500; alt=sys1250; recName="Use the Off-Grid CIM 1500H Inverter"; altName="Use the Off-Grid CIM 1200H Inverter";
                reason = p1500<p1250 ? "This system uses fewer inverters and panels, making it more cost-effective and requiring less roof area and is simpler to install." : "This system uses fewer inverters, making it more cost-effective and simpler to install.";
            } else if (p1250 < p1500) {
                rec=sys1250; alt=sys1500; recName="Use the Off-Grid CIM 1200H Inverter"; altName="Use the Off-Grid CIM 1500H Inverter";
                reason="This system uses fewer panels, making it more cost-effective and requiring less roof area and is simpler to install.";
            } else if (p1500 < p1250) {
                rec=sys1500; alt=sys1250; recName="Use the Off-Grid CIM 1500H Inverter"; altName="Use the Off-Grid CIM 1200H Inverter";
                reason="This system uses fewer panels, making it more cost-effective and requiring less roof area and is simpler to install.";
            } else {
                rec=sys1250; alt=sys1500; recName="Use the Off-Grid CIM 1200H Inverter"; altName="Use the Off-Grid CIM 1500H Inverter";
                reason="This system is the most cost-effective choice with a less expensive inverter.";
            }
            const recModel = recName.includes('1200') ? 'CIM 1200H' : 'CIM 1500H';
            const altModel = altName.includes('1200') ? 'CIM 1200H' : 'CIM 1500H';

            if (unitSystem === 'metric') {
                const dg = gallonsToExactLiters(parseFloat(userData.gallons));
                const dct = Math.round(fahrenheitToCelsius(act));
                const dht = Math.round(fahrenheitToCelsius(parseFloat(userData.hotWaterTemp)));
                const dhl = Math.round(fahrenheitToCelsius(parseFloat(userData.highLimit)));
                const rtd = calculateOptimalMetricTank(parseFloat(userData.gallons), parseFloat(userData.hotWaterTemp), parseFloat(userData.highLimit), act);
                const atd = calculateOptimalMetricTank(parseFloat(userData.gallons), parseFloat(userData.hotWaterTemp), parseFloat(userData.highLimit), act);
                const showROpt = parseFloat(userData.highLimit) > parseFloat(userData.hotWaterTemp) && rtd < dg;
                const showAOpt = parseFloat(userData.highLimit) > parseFloat(userData.hotWaterTemp) && atd < dg;
                addMessage(
                    '<strong style="font-size:17px;"><span style="color:#00E676;">‚úÖ</span> Your Solar Hot Water System Results!</strong><br><br>' +
                    'üìç <strong>Location:</strong> ' + userData.location + '<br>' +
                    'üíß <strong>Daily Hot Water:</strong> ' + dg + ' liters<br>' +
                    '‚òÄÔ∏è <strong>Peak Sun Hours:</strong> ' + aps + ' hrs/day<br>' +
                    'üå°Ô∏è <strong>Cold Water Temp:</strong> ' + dct + '¬∞C*<br>' +
                    'üî• <strong>Hot Water Temp:</strong> ' + dht + '¬∞C<br>' +
                    '‚ö° <strong>Panel Wattage:</strong> ' + userData.panelWatts + 'W<br>' +
                    'üìä <strong>High Limit:</strong> ' + dhl + '¬∞C<br><br>' +
                    '<em>*Cold water temperature has a large impact on sizing. If it seems low, measure the temperature at your cold tap, press Try Again, and enter it in Custom Seasonal Settings along with the Peak Sun Hours above.</em><br><br>' +
                    '<strong>üî∑ RECOMMENDED SYSTEM</strong><br><br>' +
                    '<strong>' + recName + '</strong><br>' +
                    '‚Ä¢ Inverters: ' + rec.inverters + '<br>‚Ä¢ Panels: ' + rec.panels + '<br>‚Ä¢ Panel Wattage: ' + userData.panelWatts + 'W<br>‚Ä¢ Element Size: ' + rec.element_size + 'W<br>‚Ä¢ Tank Size: ' + dg + ' liters<br>' +
                    '‚Ä¢ kWh/Day: <span style="color:#00E676;font-weight:600;">' + rec.kwh_day + '</span><br>' +
                    (showROpt ? '‚Ä¢ kWh/Day Max: <span style="color:#00E676;font-weight:600;">' + rec.kwh_max + '</span><br>*Optional Tank Size: ' + rtd + ' liters (mixing valve required)<br>' : '') +
                    '<br><em>' + reason + '</em><br><br>' +
                    // ‚îÄ‚îÄ ADDITION 4c: diagram button (metric recommended) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    '<button class="diagram-btn" onclick="openDiagram(\'' + recModel + '\',\'' + rec.inverters + '\',\'' + rec.panels + '\',\'' + userData.panelWatts + '\',\'' + rec.element_size + '\',\'' + dg + '\',\'' + rec.kwh_day + '\',\'' + (rec.kwh_max || rec.kwh_day) + '\',\'' + (showROpt ? rtd : '') + '\')">‚ö° How It All Connects</button><br>' +
                    '<strong>‚öôÔ∏è ALTERNATIVE OPTION</strong><br><br>' +
                    '<strong>' + altName + '</strong><br>' +
                    '‚Ä¢ Inverters: ' + alt.inverters + '<br>‚Ä¢ Panels: ' + alt.panels + '<br>‚Ä¢ Panel Wattage: ' + userData.panelWatts + 'W<br>‚Ä¢ Element Size: ' + alt.element_size + 'W<br>‚Ä¢ Tank Size: ' + dg + ' liters<br>' +
                    '‚Ä¢ kWh/Day: <span style="color:#00E676;font-weight:600;">' + alt.kwh_day + '</span><br>' +
                    (showAOpt ? '‚Ä¢ kWh/Day Max: <span style="color:#00E676;font-weight:600;">' + alt.kwh_max + '</span><br>*Optional Tank Size: ' + atd + ' liters (mixing valve required)<br>' : '') +
                    '<br>' +
                    // ‚îÄ‚îÄ ADDITION 4d: diagram button (metric alternative) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    '<button class="diagram-btn" onclick="openDiagram(\'' + altModel + '\',\'' + alt.inverters + '\',\'' + alt.panels + '\',\'' + userData.panelWatts + '\',\'' + alt.element_size + '\',\'' + dg + '\',\'' + alt.kwh_day + '\',\'' + (alt.kwh_max || alt.kwh_day) + '\',\'' + (showAOpt ? atd : '') + '\')">‚ö° How It All Connects</button><br>' +
                    getOptimalConditionsMessage(dir) +
                    '<button class="gallon-btn" onclick="copyResults()" style="margin-right:10px;">Copy Results</button>' +
                    '<button class="gallon-btn" onclick="tryAgain()">Try Again</button><br>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1200H-Spec-Sheet-Rev-6.6-Jan-2024.pdf" target="_blank" class="spec-btn">1200H Spec Sheet</a>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1500H-Spec-Sheet-Rev-6.8-Jan-2025.pdf" target="_blank" class="spec-btn">1500H Spec Sheet</a><br><br>' +
                    diyMarketing
                );
            } else {
                const dg = Math.round(userData.gallons);
                const dct = Math.round(act);
                const dht = Math.round(userData.hotWaterTemp);
                const dhl = Math.round(userData.highLimit);
                const rot = calculateOptimalImperialTank(parseFloat(userData.gallons), parseFloat(userData.hotWaterTemp), parseFloat(userData.highLimit), act);
                const aot = calculateOptimalImperialTank(parseFloat(userData.gallons), parseFloat(userData.hotWaterTemp), parseFloat(userData.highLimit), act);
                const showROpt = parseFloat(userData.highLimit) > parseFloat(userData.hotWaterTemp) && rot < dg;
                const showAOpt = parseFloat(userData.highLimit) > parseFloat(userData.hotWaterTemp) && aot < dg;
                addMessage(
                    '<strong style="font-size:17px;"><span style="color:#00E676;">‚úÖ</span> Your Solar Hot Water System Results!</strong><br><br>' +
                    'üìç <strong>Location:</strong> ' + userData.location + '<br>' +
                    'üíß <strong>Daily Hot Water:</strong> ' + dg + ' gallons<br>' +
                    '‚òÄÔ∏è <strong>Peak Sun Hours:</strong> ' + aps + ' hrs/day<br>' +
                    'üå°Ô∏è <strong>Cold Water Temp:</strong> ' + dct + '¬∞F*<br>' +
                    'üî• <strong>Hot Water Temp:</strong> ' + dht + '¬∞F<br>' +
                    '‚ö° <strong>Panel Wattage:</strong> ' + userData.panelWatts + 'W<br>' +
                    'üìä <strong>High Limit:</strong> ' + dhl + '¬∞F<br><br>' +
                    '<em>*Cold water temperature has a large impact on sizing. If it seems low, measure the temperature at your cold tap, press Try Again, and enter it in Custom Seasonal Settings along with the Peak Sun Hours above.</em><br><br>' +
                    '<strong>üî∑ RECOMMENDED SYSTEM</strong><br><br>' +
                    '<strong>' + recName + '</strong><br>' +
                    '‚Ä¢ Inverters: ' + rec.inverters + '<br>‚Ä¢ Panels: ' + rec.panels + '<br>‚Ä¢ Panel Wattage: ' + userData.panelWatts + 'W<br>‚Ä¢ Element Size: ' + rec.element_size + 'W<br>‚Ä¢ Tank Size: ' + dg + ' gallons<br>' +
                    '‚Ä¢ kWh/Day: <span style="color:#00E676;font-weight:600;">' + rec.kwh_day + '</span><br>' +
                    (showROpt ? '‚Ä¢ kWh/Day Max: <span style="color:#00E676;font-weight:600;">' + rec.kwh_max + '</span><br>*Optional Tank Size: ' + rot + ' gallons (mixing valve required)<br>' : '') +
                    '<br><em>' + reason + '</em><br><br>' +
                    // ‚îÄ‚îÄ ADDITION 4e: diagram button (imperial recommended) ‚îÄ‚îÄ‚îÄ‚îÄ
                    '<button class="diagram-btn" onclick="openDiagram(\'' + recModel + '\',\'' + rec.inverters + '\',\'' + rec.panels + '\',\'' + userData.panelWatts + '\',\'' + rec.element_size + '\',\'' + dg + '\',\'' + rec.kwh_day + '\',\'' + (rec.kwh_max || rec.kwh_day) + '\',\'' + (showROpt ? rot : '') + '\')">‚ö° How It All Connects</button><br>' +
                    '<strong>‚öôÔ∏è ALTERNATIVE OPTION</strong><br><br>' +
                    '<strong>' + altName + '</strong><br>' +
                    '‚Ä¢ Inverters: ' + alt.inverters + '<br>‚Ä¢ Panels: ' + alt.panels + '<br>‚Ä¢ Panel Wattage: ' + userData.panelWatts + 'W<br>‚Ä¢ Element Size: ' + alt.element_size + 'W<br>‚Ä¢ Tank Size: ' + dg + ' gallons<br>' +
                    '‚Ä¢ kWh/Day: <span style="color:#00E676;font-weight:600;">' + alt.kwh_day + '</span><br>' +
                    (showAOpt ? '‚Ä¢ kWh/Day Max: <span style="color:#00E676;font-weight:600;">' + alt.kwh_max + '</span><br>*Optional Tank Size: ' + aot + ' gallons (mixing valve required)<br>' : '') +
                    '<br>' +
                    // ‚îÄ‚îÄ ADDITION 4f: diagram button (imperial alternative) ‚îÄ‚îÄ‚îÄ‚îÄ
                    '<button class="diagram-btn" onclick="openDiagram(\'' + altModel + '\',\'' + alt.inverters + '\',\'' + alt.panels + '\',\'' + userData.panelWatts + '\',\'' + alt.element_size + '\',\'' + dg + '\',\'' + alt.kwh_day + '\',\'' + (alt.kwh_max || alt.kwh_day) + '\',\'' + (showAOpt ? aot : '') + '\')">‚ö° How It All Connects</button><br>' +
                    getOptimalConditionsMessage(dir) +
                    '<button class="gallon-btn" onclick="copyResults()" style="margin-right:10px;">Copy Results</button>' +
                    '<button class="gallon-btn" onclick="tryAgain()">Try Again</button><br>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1200H-Spec-Sheet-Rev-6.6-Jan-2024.pdf" target="_blank" class="spec-btn">1200H Spec Sheet</a>' +
                    '<a href="https://www.cyboenergy.com/downloads/CyboInverter-CIM-1500H-Spec-Sheet-Rev-6.8-Jan-2025.pdf" target="_blank" class="spec-btn">1500H Spec Sheet</a><br><br>' +
                    diyMarketing
                );
            }
            setTimeout(() => {
                const msgs = chatMessages.querySelectorAll('.message');
                const last = msgs[msgs.length-1];
                if (last) last.scrollIntoView({ behavior:'smooth', block:'start' });
            }, 100);
        }
    </script>
</body>
</html>
